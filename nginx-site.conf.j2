{% if USE_UWSGI is defined and USE_UWSGI == 'true' %}
  upstream {{ UPSTREAM_BACKEND_NAME|default('local_backend', true) }} {
    server {{ UPSTREAM_BACKEND_URL|default('localhost', true) }}:{{ UPSTREAM_BACKEND_PORT|default(8000, true)}} fail_timeout={{ UPSTREAM_BACKEND_TIMEOUT|default(5, true) }}s max_fails={{ UPSTREAM_BACKEND_FAILS|default(6, true) }};
  }
{% endif %}

{% if USE_STATS is defined and USE_STATS == 'true' %}
server {
    listen {{ STATS_PORT|default(9080, true) }};
    server_name 127.0.0.1;

    # nginx stats for monitoring
    location /nginx_status {
        stub_status on;       # Turn on nginx stats
        access_log   off;     # We do not need logs for stats
        allow 127.0.0.1;      # Security: Only allow access from IP
        deny all;             # Deny requests from the other of the world
    }
}
{% endif %}

{% if USE_OAUTH is defined and USE_OAUTH == 'true' %}
server {
    listen 0.0.0.0:{{ OAUTH_NGINX_PORT|default(80, true) }} default_server;
    server_name _;

    location / {
      proxy_pass http://{{ OAUTH_URL|default('127.0.0.1', true) }}:{{ OAUTH_PORT|default(4180, true) }};
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Scheme $scheme;
      proxy_connect_timeout 1;
      proxy_send_timeout 30;
      proxy_read_timeout 30;
  }
}
{% endif %}

server {
    listen      0.0.0.0:{{ NGINX_PORT|default(80, true) }} default_server;
    server_name  {{ NGINX_SERVER_NAME|default('_', true) }};

    {% if USE_STATICS is defined and USE_STATICS == 'true' %}
    location /static {
        alias /data/staticserve;
        expires 1d;
    }
    {% endif %}

    location / {
      proxy_set_header Host $host:$server_port;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      {% if USE_UWSGI is defined %}
      uwsgi_pass http://{{ UPSTREAM_BACKEND_NAME|default('local_backend', true) }};
      include /etc/nginx/conf.d/uwsgi_params;
      {% elif USE_PROXY_PASS is defined and USE_PROXY_PASS == 'true' %}
      proxy_pass http://{{ PROXY_TARGET_URL|default('localhost', true) }}:{{ PROXY_TARGET_PORT|default(8080, true) }};
      {% else %}
      root /var/www/localhost/htdocs;
      index index.html;
      {% endif %}
    }
}