version: '1.0'

steps:
  main_clone:
    title: Cloning main repository
    type: git-clone
    repo: '${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}'
    revision: '${{CF_REVISION}}'

  build_image:
    type: build
    image_name: tivix/docker-nginx
    working_directory: ${{main_clone}}
    dockerfile: Dockerfile
    tag: ${{CF_SHORT_REVISION}}
    progress: tty

  push_image:
    type: push
    candidate: ${{build_image}}
    registry: dockerhub
    tags:
      - latest
      - prod-v2.0
    when:
      condition:
        all:
          noSkipCiInCommitMessage: 'includes(lower("${{CF_COMMIT_MESSAGE}}"), "release") == true'
          masterBranch: '"${{CF_BRANCH}}" == "master"'
